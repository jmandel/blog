---
title: "Theory to Practice: LLM Agents Using MCP Tools on Real EHR Data (with demo)"
date: 2025-01-01T00:00:00
slug: theory-to-practice-llm-agents-using-mcp-tools-on-real-ehr-data-with-demo
banner: "https://media.licdn.com/mediaD5612AQElZrWw7Gcq6w"
---
<p>Last week, I <a href="https://www.linkedin.com/pulse/prior-auth-friction-cant-we-just-talk-josh-mandel-md-taq6c" target="_blank">discussed</a> how LLM agents embedded in EHRs could transform complex workflows like prior authorization by using tools to interact conversationally, rather than relying solely on rigid structured data exchange. The idea was to let agents handle the dialogue, using reliable data access standards like FHIR as the foundation.</p><p>Today, I want to show you some underpinnings what that looks like in practice.</p><p>I've put together a short video demo showcasing a system that connects Large Language Models (LLMs) directly to electronic health record data using exactly this "agent + tools" pattern.</p><div><iframe allowfullscreen="true" frameborder="0" height="405" src="https://www.linkedin.com/embeds/publishingEmbed.html?articleId=9199466672042909503" width="720"></iframe></div><h3>What's Under the Hood?</h3><p>The demo architecture involves three key pieces:</p><p>1.  <strong>SMART on FHIR Client:</strong> Uses standards (SMART, FHIR, US Core) to securely extract both structured data and unstructured clinical notes from an EHR – in this case, my own record fetched from my provider's patient portal (via Epic MyChart's FHIR endpoint).</p><p>2.  <strong>MCP Server:</strong> This acts as a middle layer, taking the fetched FHIR data and exposing a set of <em>tools</em> (like grep, SQL queries, or even JavaScript execution via eval_record) that an LLM can use to analyze that specific patient's data locally. It uses the <strong>Model Context Protocol (MCP)</strong> to define and offer these tools.</p><p>3.  <strong>AI/LLM Interface:</strong> The agent (in the demo, Gemini 2.5 Pro via the Cursor IDE) that understands the available tools (thanks to MCP) and decides which ones to call to answer user questions about the EHR data.</p><h3>Why Tools Matter</h3><p>As discussed previously, LLMs often struggle with large volumes of raw structured data like FHIR JSON. Pasting megabytes of JSON into the context window isn't efficient. However, LLMs excel at <em>using tools</em>. Give them a grep tool to search notes, or an eval tool to run code against the structured data, and they become much more powerful and efficient analysts.</p><h3>The Demo Shows</h3><ul><li><p><strong>Fetching Real Data</strong>: Connecting to a provider via SMART on FHIR, authorizing access, and pulling the US Core dataset into a local SQLite database.</p></li><li><p><strong>Agent Querying</strong>: The LLM using MCP-defined tools like <em>grep</em> to find active conditions.</p></li><li><p><strong>Agent Analysis</strong>: The LLM using <em>eval </em> to execute JavaScript (iterating through FHIR Observations to calculate things like average blood pressure)</p></li><li><p><strong>Agent Synthesis</strong>: The LLM combining information from structured data and unstructured notes (found via grep) to provide comprehensive summaries (timeline of Post-concussion syndrome)</p></li></ul><h3>The Role of MCP and Standardization</h3><p>This demo leverages the <strong>Model Context Protocol (MCP)</strong> – a developing standard designed specifically for agent-to-tool communication. It allows the server to advertise its capabilities (the tools) and their documentation, enabling the LLM agent to intelligently select and use them.</p><p>This reinforces the idea from the last post: maybe our intense standardization efforts yield more value when focused on:</p><p>1.  <strong>Robust Data Access:</strong> Reliable, performant APIs like FHIR for getting the necessary data <em>out</em> of the EHR.</p><p>2.  <strong>Interoperable Tool Protocols:</strong> Standards like MCP for how agents <em>discover and interact</em> with tools that operate on that data.</p><h3>Early Days &amp; Security</h3><p>This is still evolving rapidly. The video touches on the crucial security aspects – OAuth flows for authorization (both between the user and the EHR, as well as between the LLM client and the MCP server), the emerging risks of prompt injection or malicious tool outputs influencing agent behavior, and the UX challenges of user confirmation before tool execution. We need robust security models as these capabilities mature.</p><h3>Check it Out</h3><p>Watch the demo to see these concepts in action. The code is open source if you want to dig deeper into the implementation. Let's continue the discussion on how we can best leverage LLM agents and standards like FHIR and MCP to build better health IT.</p><ul><li><p>Video: <a href="https://youtu.be/K0t6MRyIqZU" target="_blank">https://youtu.be/K0t6MRyIqZU</a></p></li><li><p>GitHub repo: <a href="https://github.com/jmandel/health-record-mcp" target="_blank"><strong>https://github.com/jmandel/health-record-mcp</strong></a></p></li></ul><p>#FHIR #LLM #AIinHealthcare #MCP #HealthIT #Interoperability #SMARTonFHIR #EHR #AgenticAI </p>