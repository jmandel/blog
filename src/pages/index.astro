---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

type ArticleEntry = CollectionEntry<'blog'>;
type ShareEntry = CollectionEntry<'shares'>;

const articles = await getCollection('blog');
const shares = await getCollection('shares');

const timeline = [
  ...articles.map((entry) => ({ kind: 'article' as const, entry })),
  ...shares.map((entry) => ({ kind: 'share' as const, entry })),
].sort((a, b) => new Date(b.entry.data.date).getTime() - new Date(a.entry.data.date).getTime());

function formatDate(date: Date | string): string {
  const d = new Date(date);
  return d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function getExcerpt(content: string | undefined): string {
  if (!content) {
    return 'Read more...';
  }
  // Skip frontmatter and find first meaningful content
  const lines = content.split('\n');
  let startIndex = 0;
  
  // Skip frontmatter if present
  if (lines[0]?.trim() === '---') {
    const endIndex = lines.findIndex((line, index) => index > 0 && line.trim() === '---');
    if (endIndex > 0) {
      startIndex = endIndex + 1;
    }
  }
  
  // Find first non-empty line that's not just markdown image syntax
  const contentLines = lines.slice(startIndex);
  const meaningfulLine = contentLines.find(line => {
    const trimmed = line.trim();
    return trimmed.length > 0 && 
           !trimmed.startsWith('![') && // Skip image markdown
           !trimmed.startsWith('#') &&  // Skip headers
           !trimmed.startsWith('=') &&  // Skip header underlines
           !trimmed.startsWith('Created on') &&  // Skip metadata
           !trimmed.startsWith('Published on') &&   // Skip metadata
           !/^\*?Based on\b/i.test(trimmed) &&      // Skip boilerplate link refs
           !trimmed.startsWith('[Shared link]');    // Skip importer link footer
  }) || '';
  
  // Clean up markdown syntax and HTML tags
  let excerpt = meaningfulLine
    .replace(/!\[.*?\]\(.*?\)/g, '') // Remove image markdown
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to just text
    .replace(/<[^>]*>/g, '') // Remove HTML tags
    .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markdown
    .replace(/\*(.*?)\*/g, '$1') // Remove italic markdown
    .replace(/`([^`]+)`/g, '$1') // Remove code markdown
    .trim();
  
  return excerpt.length > 0 ? excerpt.substring(0, 150) + '...' : 'Read more...';
}
---

<BaseLayout 
  title="Interop Blog" 
  description="Insights on healthcare IT, FHIR, EHR systems, and digital health innovation"
>
  <section>
    <h2>Recent Posts</h2>
    <div class="post-grid">
      {timeline.map((item) => {
        if (item.kind === 'article') {
          const post = item.entry as ArticleEntry;
          const slug = post.data.slug ?? post.slug;
          const hasBanner = Boolean(post.data.banner);
          return (
            <article class="post-card">
              <a
                class:list={{
                  'post-card__link': true,
                  'post-card__link--no-image': !hasBanner,
                }}
                href={`/blog/posts/${slug}`}
              >
                {hasBanner && (
                  <img
                    class="post-card__image"
                    src={post.data.banner.src}
                    alt={post.data.banner.alt ?? ''}
                  />
                )}
                <div class="post-card__content">
                  <h3>{post.data.title}</h3>
                  <time datetime={new Date(post.data.date).toISOString()}>
                    {formatDate(post.data.date)}
                  </time>
                  <p>{getExcerpt(post.body)}</p>
                </div>
              </a>
            </article>
          );
        }

        const share = item.entry as ShareEntry;
        const slug = share.data.slug ?? share.slug;
        return (
          <article class="post-card post-card--share">
            <a class="post-card__link post-card__link--no-image" href={`/blog/shares/${slug}`}>
              <div class="post-card__content">
                <h3>{share.data.title}</h3>
                <time datetime={new Date(share.data.date).toISOString()}>
                  {formatDate(share.data.date)}
                </time>
                <p>{getExcerpt(share.body)}</p>
              </div>
            </a>
          </article>
        );
      })}
    </div>
  </section>
</BaseLayout>

<style>
  .intro {
    margin: 0 0 1.5rem;
    font-size: 1.08rem;
    color: var(--color-text-muted, #64748b);
  }

  .post-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-top: 1.5rem;
  }

  .post-card {
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 1rem;
    overflow: hidden;
    background: var(--color-surface, #fff);
    box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    height: 100%;
  }

  .post-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .post-card__link--no-image {
    padding-top: 1.5rem;
  }

  .post-card__image {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .post-card__content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .post-card--share .post-card__content {
    gap: 0.5rem;
  }

  .post-card__content h3 {
    margin: 0;
    font-size: 1.4rem;
    line-height: 1.25;
  }

  .post-card--share .post-card__content h3 {
    font-size: 1.2rem;
  }

  .post-card__content time {
    font-size: 0.95rem;
    color: var(--color-text-muted, #6b7280);
    letter-spacing: 0.01em;
  }

  .post-card__content p {
    margin: 0;
    color: var(--color-text, #1f2937);
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
  }

  @media (max-width: 600px) {
    .post-card__image {
      height: 180px;
    }
  }
</style>
